# UDP Test Tools

UDPパケットの送受信テストを行うためのツールセットです。パケットロス率や遅延時間の測定ができます。

## ビルド

```bash
make
```

## プログラム

### udp_tx (送信)

UDPパケットを送信するプログラムです。Raw socketを使用してIPヘッダを含めたパケットを生成します。

```bash
./udp_tx [options]
```

**オプション:**
- `-s IP4_ADDRESS` : 送信元アドレス (デフォルト: 0.0.0.0)
- `-d IP4_ADDRESS` : 宛先アドレス (デフォルト: 192.168.0.158)
- `-c SECONDS` : 送信時間（秒） (デフォルト: 10)
- `-t TOS` : TOS優先度 0-7 (デフォルト: 0)
- `-p PORT_NUMBER` : ポート番号 (デフォルト: 44444)
- `-o PPS` : 1秒あたりのパケット数 (デフォルト: 1000)
- `-l UDP_PAYLOAD_SIZE` : UDPペイロードサイズ (デフォルト: 1000)
- `-x LAP_INTERVAL` : ラップ表示間隔 (デフォルト: 100)
- `-n` : 受信側を停止させない

### udp_rx (受信)

UDPパケットを受信するプログラムです。パケットロス率や遅延時間を計測します。

```bash
./udp_rx [options]
```

**オプション:**
- `-p PORT_NUMBER` : ポート番号 (デフォルト: 44444)
- `-n` : 受信を継続（終了パケットで停止しない）
- `-l` : ログを有効化（`./log/`ディレクトリに保存）

### udp_trx (送受信)

UDPパケットを受信し、送信元に返送するトランシーバープログラムです。往復遅延時間（RTT）の測定に使用できます。

```bash
./udp_trx [options]
```

**オプション:**
- `-d IP4_ADDRESS` : 宛先アドレス (デフォルト: 192.168.1.1)
- `-p PORT_NUMBER` : ポート番号 (デフォルト: 44444)
- `-n` : 受信を継続

## 分析ツール

### grap_lap.py

ログファイルからラップデータを抽出し、線形回帰を行ってグラフ表示するPythonスクリプトです。

```bash
python3 grap_lap.py <logfile>
```

**依存パッケージ:**
- numpy
- matplotlib

## 使用例

### 片道測定

受信側（Host B）で起動:
```bash
./udp_rx -p 44444
```

送信側（Host A）で実行:
```bash
# Raw socketを使用するためroot権限が必要
sudo ./udp_tx -d 192.168.0.100 -p 44444 -o 1000 -c 10
```

### 往復測定 (RTT)

中継側（Host B）で起動:
```bash
./udp_trx -d 192.168.0.1 -p 44444
```

送信側（Host A）で受信プログラムを起動:
```bash
./udp_rx -p 44444
```

送信側（Host A）で送信を実行:
```bash
# Raw socketを使用するためroot権限が必要
sudo ./udp_tx -d 192.168.0.100 -p 44444 -o 1000 -c 10
```

### 権限に関する注意

| プログラム | root権限 | 理由 |
|-----------|---------|------|
| udp_tx | **必要** (sudo) | Raw socket (IPPROTO_RAW) を使用してIPヘッダを直接操作 |
| udp_rx | 不要 | 通常のUDPソケット (SOCK_DGRAM) を使用 |
| udp_trx | 不要 | 通常のUDPソケット (SOCK_DGRAM) を使用 |

## パケットフォーマット

### 設計概要

本ツールは、ネットワークの品質測定を目的として設計されています。

**測定可能な項目:**
- **パケットロス率**: 送信カウンタと受信カウンタの比較により算出
- **片道遅延 (One-Way Delay)**: 送信時刻と受信時刻の差分（時刻同期が前提）
- **往復遅延 (RTT)**: trxを経由した往復時間の測定
- **QoS動作確認**: TOS/Precedenceフィールドによる優先度別の挙動測定

### ヘッダ構造（32バイト）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type (1)   |    TOS (1)    |       Payload Size (2)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      TX Timestamp Sec (4)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      TX Timestamp USec (4)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        TX Counter (4)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Reserved / RX Counter (4)                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      RX Timestamp Sec (4)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      RX Timestamp USec (4)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        RX Counter (4)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### フィールド詳細

| オフセット | サイズ | フィールド名 | 型 | 説明 |
|-----------|--------|--------------|-----|------|
| 0 | 1 | Type | char | パケット種別 |
| 1 | 1 | TOS | uint8_t | Type of Service (Precedence << 5) |
| 2 | 2 | Payload Size | uint16_t | UDPペイロードサイズ |
| 4 | 4 | TX Timestamp Sec | uint32_t | 送信時刻（秒: time_t） |
| 8 | 4 | TX Timestamp USec | uint32_t | 送信時刻（マイクロ秒） |
| 12 | 4 | TX Counter | uint32_t | 送信パケットカウンタ |
| 16 | 4 | Reserved / RX Counter | uint32_t | trx用: 受信カウンタ |
| 20 | 4 | RX Timestamp Sec | uint32_t | 受信時刻（秒） |
| 24 | 4 | RX Timestamp USec | uint32_t | 受信時刻（マイクロ秒） |
| 28 | 4 | RX Counter | uint32_t | rx用: 受信パケットカウンタ |

### パケット種別 (Type)

| 種別 | 文字 | 説明 | 送信タイミング |
|------|------|------|----------------|
| Start | `S` | 測定開始 | 最初のパケット |
| Continue | `C` | 測定継続 | 通常のパケット |
| Lap | `L` | ラップ（中間報告） | LAP_INTERVAL毎 |
| End | `E` | 測定終了 | 最後のパケット |
| Finish | `F` | 完了通知 | 測定完了後に別途送信 |

**設計意図:**
- `S`: 受信側でカウンタをリセットし、測定開始を認識
- `C`: 高速送信時のオーバーヘッド削減（出力なし）
- `L`: リアルタイムで進捗確認（100パケット毎等）
- `E`: 最終パケットで暫定結果を表示
- `F`: 測定完了後1秒待機して送信、受信側の終了トリガー

---

### 各プログラムでのフィールド使用

#### udp_tx（送信側）

**書き込むフィールド:**

| オフセット | フィールド | 処理内容 |
|-----------|------------|----------|
| 0 | Type | パケット種別を設定 |
| 1 | TOS | Precedence値を5bit左シフトして設定 |
| 2-3 | Payload Size | 設定されたペイロードサイズを格納 |
| 4-7 | TX Timestamp Sec | `gettimeofday()`で取得した秒を格納 |
| 8-11 | TX Timestamp USec | `gettimeofday()`で取得したマイクロ秒を格納 |
| 12-15 | TX Counter | 送信パケット番号（1から連番） |

**設計意図:**
- Raw socketを使用してIPヘッダから生成
- TOSフィールドをIPヘッダに反映させ、QoS動作を確認可能
- タイムスタンプは`gettimeofday()`で高精度に取得
- タイマー割り込み（SIGALRM）で正確なPPS制御

```
[udp_tx] ─────送信─────▶ ネットワーク
          Type=S/C/L/E
          TOS=priority
          TX_Time=now
          TX_Counter=n
```

---

#### udp_rx（受信側）

**読み取るフィールド:**

| オフセット | フィールド | 処理内容 |
|-----------|------------|----------|
| 0 | Type | パケット種別で処理分岐 |
| 1 | TOS | bit[7:5]からPrecedenceを抽出して表示 |
| 2-3 | Payload Size | ペイロードサイズを取得 |
| 4-7 | TX Timestamp Sec | 遅延計算に使用 |
| 8-11 | TX Timestamp USec | 遅延計算に使用 |
| 12-15 | TX Counter | パケットロス率計算に使用 |

**書き込むフィールド（ログ用）:**

| オフセット | フィールド | 処理内容 |
|-----------|------------|----------|
| 20-23 | RX Timestamp Sec | 受信時刻（秒）を記録 |
| 24-27 | RX Timestamp USec | 受信時刻（マイクロ秒）を記録 |
| 28-31 | RX Counter | 受信パケットカウンタを記録 |

**設計意図:**
- 片道遅延 = RX_Time - TX_Time（要時刻同期）
- パケットロス率 = 1 - (RX_Counter / TX_Counter)
- ログファイルには32バイトのバイナリで記録（後から詳細分析可能）

```
ネットワーク ─────受信─────▶ [udp_rx]
                              ├─ 遅延計算: now - TX_Time
                              ├─ ロス計算: 1 - (rx_cnt / TX_Counter)
                              └─ ログ書込: 32バイト/パケット
```

**出力フォーマット:**
```
S <payload_size> <rx_counter>                              <tx_sec>.<tx_usec> <delay_us>
L <tos> <rx_counter> /<tx_counter> <loss_rate>   <tx_sec>.<tx_usec> <delay_us>
E <tos> <rx_counter> /<tx_counter> <loss_rate>   <tx_sec>.<tx_usec> <delay_us>
F <tos> <rx_counter> /<tx_counter> <loss_rate>   <tx_sec>.<tx_usec> <delay_us>
```

---

#### udp_trx（トランシーバー）

**読み取るフィールド:**

| オフセット | フィールド | 処理内容 |
|-----------|------------|----------|
| 0 | Type | パケット種別で処理分岐 |
| 2-3 | Payload Size | 返送サイズの決定 |
| 4-7 | TX Timestamp Sec | そのまま保持（RTT計算用） |
| 8-11 | TX Timestamp USec | そのまま保持（RTT計算用） |
| 12-15 | TX Counter | そのまま保持 |

**書き込むフィールド（返送用）:**

| オフセット | フィールド | 処理内容 |
|-----------|------------|----------|
| 16-19 | RX Counter | 受信パケットカウンタを格納 |
| 20-23 | RX Timestamp Sec | 中継時刻（秒）を記録 |
| 24-27 | RX Timestamp USec | 中継時刻（マイクロ秒）を記録 |

**設計意図:**
- TX_Timestampを保持したまま返送することで、送信元でRTTを計算可能
- 中継時刻を追加することで、片道遅延の内訳も把握可能
- 受信パケットをそのまま返送（ペイロードサイズ維持）

```
[udp_tx] ──送信──▶ [udp_trx] ──返送──▶ [udp_rx @ tx側]
           │          │
           │          └─ RX_Time追記
           │             RX_Counter追記
           │
           └─ TX_Time, TX_Counter
              はそのまま保持
```

**RTT計算（送信元で実施）:**
```
RTT = 現在時刻 - TX_Timestamp
片道遅延(往路) = RX_Timestamp - TX_Timestamp
片道遅延(復路) = 現在時刻 - RX_Timestamp
```

---

### データフロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                      片道測定モード                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Host A: udp_tx]                      [Host B: udp_rx]         │
│       │                                      │                  │
│       │  ┌──────────────────────────────┐    │                  │
│       ├──│ Type | TOS | Size           │───▶├─ 遅延計測        │
│       │  │ TX_Sec | TX_USec | TX_Cnt   │    ├─ ロス率計算      │
│       │  │ (Reserved area)             │    └─ ログ出力        │
│       │  └──────────────────────────────┘                       │
│       │                                                         │
│       ▼  (PPS制御でN回送信)                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      往復測定モード (RTT)                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  [Host A: udp_tx]         [Host B: udp_trx]    [Host A: udp_rx] │
│       │                         │                    │          │
│       │  ┌─────────────────┐    │                    │          │
│       ├──│ TX_Time=T0      │───▶│                    │          │
│       │  │ TX_Counter=N    │    │                    │          │
│       │  └─────────────────┘    │                    │          │
│       │                         │                    │          │
│       │                         │  ┌─────────────┐   │          │
│       │                         ├──│ TX_Time=T0  │──▶├─ RTT計測 │
│       │                         │  │ RX_Time=T1  │   │  =now-T0 │
│       │                         │  │ RX_Cnt=M    │   │          │
│       │                         │  └─────────────┘   │          │
│       │                         │                    │          │
│       ▼                         ▼                    ▼          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

### ログファイルフォーマット

udp_rxで`-l`オプションを指定した場合、`./log/`ディレクトリにバイナリログが保存されます。

**ファイル名:** `RX_<port>_<YYMMDD_HHMMSS>.log`

**レコード構造:** 32バイト/パケット（ヘッダ全体をそのまま保存）

```python
# Pythonでの読み込み例
import struct

with open('log/RX_44444_250108_120000.log', 'rb') as f:
    while True:
        data = f.read(32)
        if len(data) < 32:
            break
        type_char = chr(data[0])
        tos = data[1]
        payload_size = struct.unpack('<H', data[2:4])[0]
        tx_sec = struct.unpack('<I', data[4:8])[0]
        tx_usec = struct.unpack('<I', data[8:12])[0]
        tx_counter = struct.unpack('<I', data[12:16])[0]
        rx_sec = struct.unpack('<I', data[20:24])[0]
        rx_usec = struct.unpack('<I', data[24:28])[0]
        rx_counter = struct.unpack('<I', data[28:32])[0]
```

## ライセンス

このプロジェクトのライセンスについては、リポジトリの所有者にお問い合わせください。
