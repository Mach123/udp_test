# UDP Test Tools

UDPパケットの送受信テストを行うためのツールセットです。パケットロス率や遅延時間の測定ができます。

---

## ビルド

```bash
$ make
```
> **NOTE**: 本リポジトリのルートに `Makefile` があり、`make` を実行すると `udp_tx`, `udp_rx`, `udp_trx` がビルドされます。

---

## 使用方法

### ビルド済みバイナリの実行例

#### udp_tx (送信)

UDPパケットを送信するプログラムです。Raw socket を使用して IP ヘッダを含めたパケットを生成します。

```bash
# sudo が必要です
# 例: 10 秒間、1,000 PPS で送信
# sudo ./udp_tx -d 192.168.0.100 -p 44444 -o 1000 -c 10
```

**オプション:**

| オプション | 説明 |
|------------|------|
| `-s` `IP4_ADDRESS` | 送信元アドレス (デフォルト: 0.0.0.0) |
| `-d` `IP4_ADDRESS` | 宛先アドレス (デフォルト: 192.168.0.158) |
| `-c` `SECONDS` | 送信時間（秒） (デフォルト: 10) |
| `-t` `TOS` | TOS 優先度 0‑7 (デフォルト: 0) |
| `-p` `PORT_NUMBER` | ポート番号 (デフォルト: 44444) |
| `-o` `PPS` | 1 秒あたりのパケット数 (デフォルト: 1000) |
| `-l` `UDP_PAYLOAD_SIZE` | UDP ペイロードサイズ (デフォルト: 1000) |
| `-x` `LAP_INTERVAL` | ラップ表示間隔 (デフォルト: 100) |
| `-n` | 受信側を停止させない |

---

#### udp_rx (受信)

UDPパケットを受信し、パケットロス率や遅延時間を計測します。

```bash
$ ./udp_rx [options]
```

**オプション:**

| オプション | 説明 |
|------------|------|
| `-p` `PORT_NUMBER` | ポート番号 (デフォルト: 44444) |
| `-n` | 受信を継続（終了パケットで停止しない） |
| `-l` | ログを有効化（`./log/` ディレクトリに保存） |

> **NOTE**: `-l` オプションを使用する場合、事前に `mkdir -p ./log` でディレクトリを作成してください。

---

#### udp_trx (送受信)

受信したパケットをそのまま送信元に返送し、往復遅延時間（RTT）を測定します。

```bash
$ ./udp_trx [options]
```

**オプション:**

| オプション | 説明 |
|------------|------|
| `-d` `IP4_ADDRESS` | 宛先アドレス (デフォルト: 192.168.1.1) |
| `-p` `PORT_NUMBER` | ポート番号 (デフォルト: 44444) |
| `-n` | 受信を継続 |

---

## 権限に関する注意

| プログラム | root権限 | 理由 |
|-----------|----------|------|
| `udp_tx` | **必要** (sudo) | Raw socket (IPPROTO_RAW) を使用して IP ヘッダを直接操作 |
| `udp_rx` | 不要 | 通常の UDP ソケット (SOCK_DGRAM) を使用 |
| `udp_trx` | 不要 | 通常の UDP ソケット (SOCK_DGRAM) を使用 |

---

## パケットフォーマット

### ヘッダ構造（32 バイト）

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|    Type (1)   |    TOS (1)    |       Payload Size (2)        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      TX Timestamp Sec (4)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      TX Timestamp USec (4)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        TX Counter (4)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Reserved / RX Counter (4)                  |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      RX Timestamp Sec (4)                     |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                      RX Timestamp USec (4)                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        RX Counter (4)                         |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

### フィールド詳細

| オフセット | サイズ | フィールド名 | 型 | 説明 |
|-----------|--------|--------------|-----|------|
| 0 | 1 | Type | char | パケット種別 |
| 1 | 1 | TOS | uint8_t | Type of Service (Precedence << 5) |
| 2 | 2 | Payload Size | uint16_t | UDP ペイロードサイズ |
| 4 | 4 | TX Timestamp Sec | uint32_t | 送信時刻（秒） |
| 8 | 4 | TX Timestamp USec | uint32_t | 送信時刻（マイクロ秒） |
| 12 | 4 | TX Counter | uint32_t | 送信パケットカウンタ |
| 16 | 4 | Reserved / RX Counter | uint32_t | trx 用: 受信カウンタ |
| 20 | 4 | RX Timestamp Sec | uint32_t | 受信時刻（秒） |
| 24 | 4 | RX Timestamp USec | uint32_t | 受信時刻（マイクロ秒） |
| 28 | 4 | RX Counter | uint32_t | 受信パケットカウンタ |

### パケット種別 (Type)

| 種別 | 文字 | 説明 | 送信タイミング |
|------|------|------|----------------|
| Start | `S` | 測定開始 | 最初のパケット |
| Continue | `C` | 測定継続 | 通常のパケット |
| Lap | `L` | ラップ（中間報告） | LAP_INTERVAL 毎 |
| End | `E` | 測定終了 | 最後のパケット |
| Finish | `F` | 完了通知 | 測定完了後に別途送信 |

---

## ログファイルフォーマット

`udp_rx` で `-l` オプションを付けると `./log/` ディレクトリにバイナリログが保存されます。

**ファイル名:** `RX_<port>_<YYMMDD_HHMMSS>.log`

**レコード構造:** 32 バイト / パケット（ヘッダ全体をそのまま保存）

```python
# Python での読み込み例
import struct

with open('log/RX_44444_250108_120000.log', 'rb') as f:
    while True:
        data = f.read(32)
        if len(data) < 32:
            break
        type_char = chr(data[0])
        tos = data[1]
        payload_size = struct.unpack('<H', data[2:4])[0]
        tx_sec = struct.unpack('<I', data[4:8])[0]
        tx_usec = struct.unpack('<I', data[8:12])[0]
        tx_counter = struct.unpack('<I', data[12:16])[0]
        rx_sec = struct.unpack('<I', data[20:24])[0]
        rx_usec = struct.unpack('<I', data[24:28])[0]
        rx_counter = struct.unpack('<I', data[28:32])[0]
```

---
## 分析ツール

`grap_lap.py` は、`udp_rx` のログファイルからラップ (Lap) データを抽出し、ラップ番号とタイムスタンプの線形回帰を行う簡易分析ツールです。主な機能:
- ログファイル (`RX_*.log`) を読み取り、`L` 行（ラップ）からラップ番号と受信時刻を取得
- ラップ番号 (x) と受信時刻 (y) の最小二乗直線 `y = a*x + b` を計算
- 回帰係数 `a`（レート） と切片 `b` を標準出力に表示
- ラップデータと回帰直線を散布図として描画し、`matplotlib` で表示

### 使い方

```bash
python3 grap_lap.py <logfile>
```

例:

```bash
$ python3 grap_lap.py log/RX_44444_230101_120000.log
0.123456 158.0
```

上記は `a = 0.123456`（ラップ番号 1 増加あたりのマイクロ秒） と `b = 158.0`（最初のラップ時刻） を示します。`matplotlib` がインストールされていない場合は `pip install matplotlib` でインストールしてください。

---

## ライセンス

このプロジェクトは **MIT License** です。詳細は `LICENSE` ファイルをご参照ください。
